const assert = require('assert');
const path = require('path');
const util = require('./utils');
const async = require('async');
const BigNumber = require("bignumber.js");
const testdata = require('./data/secp2561k_data.json');

var secp256k1;

const bytecode = "0x6060604052611286806100126000396000f3606060405260e060020a600035046304e960d7811461004757806323e47a01146101955780634f5dde4c146101e75780639f6fc3c014610222578063da8b0d711461029d575b005b60408051808201825261034991600480359290916064919060249060029083908390808284378051808201825292979660a4965092945091929184915083908082843750909550505050505060006103a184848460006000600060006060604051908101604052806003905b60008152602001906001900390816100b357505060408051606081019091526003815b60008152602001906001900390816100d657505060408051606081019091526003815b60008152602001906001900390816100f9575050885170014551231950b75fc4402da1732fc9bebe1996506401000003d019955060009081148061013f57508951879010155b8061014e575060208a01516000145b8061017d575060208a01517f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a090115b156103bf57600097505b505050505050509392505050565b60408051808201825261035d9160049160449183906002908390839080828437509095505050505050600060006103a9836000808281508051915060016020919091015181161461063e576000610641565b604080518082018252610349916004916044918390600290839083908082843750909550505050505060006103b2825b60006103b282610252565b604080518082018252610349916004916044918390600290839083908082843750909550505050505060006103b2825b60006401000003d01981808481505181148061026e5750845183145b8061027d575060208501516000145b8061028b5750602085015183145b1561064857600093505b505050919050565b61037d6004356024356040604051908101604052806002905b60008152602001906001900390816102b6579050506103b883836040604051908101604052806002905b60008152602001906001900390816102e057506401000003d0199050600080808360078180898009890908925061066f837f3fffffffffffffffffffffffffffffffffffffffffffffffffffffffbfffff0c86600060008460001415610e06575b509392505050565b604080519115158252519081900360200190f35b604051808360ff1681526020018281526020019250505060405180910390f35b60408051908190839080838184600060046021f15090500191505060405180910390f35b949350505050565b91509150915091565b92915050565b9392505050565b6103c889610217565b15156103d75760009750610187565b60208a015161041190885b60006000600060006000600087600014806103fc57508688145b806104075750866000145b156106af57610002565b945061055187868d09604080518082019091527f79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179881527f483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b860208201525b6060604051908101604052806003905b600081526020019060019003908161047e57905050600060006000610300604051908101604052806008905b6060604051908101604052806003905b60008152602001906001900390816104ba579050508152602001906001900390816104aa57505060408051606081019091526003815b60008152602001906001900390816104f05750506040805161020081019091526010815b6000815260200190600190039081610514579050506000600060006401000003d01998508b600014156106ff575b50505050505050505092915050565b935061056687868c600050508c51098a61046e565b92506105fd84845b6060604051908101604052806003905b600081526020019060019003908161057e5790505060006080604051908101604052806004905b60008152602001906001900390816105a557505060408051608081019091526004815b60008152602001906001900390816105c8575060009050808080808a60029090602002015160001415610cee57899850610ce0565b6040810151909250600014156106165760009750610187565b604082015161062590876103e2565b905085868283098351098a518882061498509050610187565b60015b9150915091565b60208501518390800985519092508390600790829081818009090890508082149350610295565b8686529150506001811660ff8716186000811461068e57818403610690565b815b6020860152509295945050505050565b8495505b505050505092915050565b868811156106bd5796869006965b600193508692508791505b600082146106e95750919282820480850290910392918183029003906106c8565b60008512156106a05784600003870395506106a4565b6000604051985061020089016040525b8c156107475760018d1615610736575060208c06808989015360206010821102818e03019c505b60028d049c5060018801975061070f565b50604080516060810182528c51815260208d8101519082015260019181019190915280875261077590610830565b9450610877858c6060604051908101604052806003905b600081526020019060019003908161078c5790505060006040604051908101604052806002905b60008152602001906001900390816107b357505060408051608081019091526004815b60008152602001906001900390816107d6575060009050808080808a60029090602002015160001415610ef657604080516060810182528b51815260208c810151908201526001918101919091529850610ce0565b610dff8b5b6060604051908101604052806003905b600081526020019060019003908161084057506401000003d0199050600080808080808860025060400151811415610e8557610eea565b6020870181905261088990869061056e565b6040870181905261089b90869061056e565b606087018190526108ad90869061056e565b608087018190526108bf90869061056e565b60a087018190526108d190869061056e565b60c087018190526108e390869061056e565b60e087015260208601516040015180855289908760025050604088810151015109602085018190526060870151604001518a9190096040858101829052608088015101518a9190096060850181905260a0870151604001518a9190096080850181905260c0870151604001518a91900960a0850181905260e0870151604001518a91900960c08501819052610978908a6103e2565b60e08501819052610100850181905260a08501518a9190096101e0850152600692505b60028310610a025761010084015189908760018601600881101561000257602002015160400151096101008501819052899085600119860160108110156100025760200201510984846008016010811015610002576020020152600019929092019161099b565b6040868101516101008601519101518a919009610120850152600092505b6007831015610c1b57610aa686846001016008811015610002576020020151856009860160108110156100025760200201518b87600988016010811015610002576020020151886009890160108110156100025760200201510982518d908190839009845280808385096020860151096020850152505060016040929092019190915250565b60019290920191610a20565b6010821115610bb757600282601f030490508050610c1b8a60406040519081016040528089856008811015610002575050602085028a015160009090602002015181526020018985600881101561000257505060208581028b015101518d0390525b60006040604051908101604052806002905b6000815260200190600190039081610b2657505060408051608081019091526004815b6000815260200190600190039081610b495750600090508080808089600190906020020151600014156111a25788518a52602089810151908b0152600160408b0152611196565b6112818a5b6401000003d01960008080808080876002506040015181141561108e576110f3565b6000821115610c1b576002600183030490508050610c1b8a60406040519081016040528089856008811015610002575050602085028a015160009090602002015181526020018985600881101561000257505060208581028b015101519052610b14565b6000871115610542578688016000199081015197019660001a9150610ab28a610b95565b8551604087015189918203900860208701516060880151919650899190820390089350878586099250878584099150878289038986870908905087808085896000505089510960020989038208808a5286519091508890819083820390829087900908850960208a8101919091528601518890819084900981038a6001909060200201510860208a015260408a810151908c01518991829109860960408a01525b505050505050505092915050565b60408a015160001415610d03578a9850610ce0565b60408b01516401000003d01998508890800980885260408c015189919009602088015260408a01518890800960408881018290528b015189919009606088015260408051608081018252908801518c5182918b9109815260200189896003600481101561000257505060608a015160208f015109815260200189896000600481101561000257505089518d5109815260200189896001600481101561000257505060208a810151908e0151099052955085600290906020020151866000600481101561000257909060200201511415610c3f57856003909060200201518660016004811015610002579090602002015114151561082b57610ce0565b9850610ce0565b8360001415610e185760019150610341565b8260001415610e2657610002565b506001905060ff60020a5b801561034157828185161515860a84848509099150826002820485161515860a84848509099150826004820485161515860a84848509099150826008820485161515860a8484850909915060109004610e31565b885160208a015190965094508685800993508687858809600409925086878788096003099150868784850888038884850908808952905086808086800960080988038889848b0387088509086020890152604089015187908190870960020960408901525b50505050505050919050565b60208a015160001415610f0b578a9850610ce0565b60408b01516401000003d01998508890800980885260408c015189919009602088810191909152604080516080810182528d5181528d83015192810192909252810189896000505089518d5109815260200189896001600281101561000257505060208a810151908e0151099052955085600290906020020151866000600481101561000257909060200201511415610fe1578560039090602002015186600160048110156100025790906020020151141515610fd8576000808c5260208c0181905260408c0152610ce0565b6110888b610830565b8551604087015189918203900860208701516060880151919650899190820390089350878586099250878584099150878289038986870908905087808085896000505089510960020989038208808a5286519091508890819083820390829087900908850960208a8101919091528601518890819084900981038a6001909060200201510860208a015260408b01518890860960408a015250969998505050505050505050565b50610ce0565b8751602089015190965094508685800993508687858809600409925086878788096003099150868784850888038884850908808952905086808086800960080988038889848b0387088509086020890152604088015187908190870960020960408901525b5050505050505050565b8551604087015189918203900860208701516060880151919650899190820390089350878586099250878584099150878289038986870908905087808085896000505089510960020989038208808b5286519091508890819083820390829087900908850960208b8101919091528601518890819084900981038b6001909060200201510860208b015260408a01518890860960408b01525b50505050505050505050565b6020890151600014156111b457611196565b60408a01516401000003d01998508890800980885260408b015189919009602088810191909152604080516080810182528c5181528c83015192810192909252810189896000505089518c5109815260200189896001600281101561000257505060208a810151908d01510990529550856002909060200201518660006004811015610002579090602002015114156110fd578560039090602002015186600160048110156100025790906020020151141515610b90576000808b5260208b0181905260408b0152611196565b61119656";
const ABI = [{
    "constant": true,
    "inputs": [{"name": "h", "type": "bytes32"}, {"name": "rs", "type": "uint256[2]"}, {
        "name": "Q",
        "type": "uint256[2]"
    }],
    "name": "validateSignature",
    "outputs": [{"name": "", "type": "bool"}],
    "type": "function"
}, {
    "constant": true,
    "inputs": [{"name": "P", "type": "uint256[2]"}],
    "name": "compress",
    "outputs": [{"name": "yBit", "type": "uint8"}, {"name": "x", "type": "uint256"}],
    "type": "function"
}, {
    "constant": true,
    "inputs": [{"name": "P", "type": "uint256[2]"}],
    "name": "isPubKey",
    "outputs": [{"name": "", "type": "bool"}],
    "type": "function"
}, {
    "constant": true,
    "inputs": [{"name": "P", "type": "uint256[2]"}],
    "name": "onCurve",
    "outputs": [{"name": "", "type": "bool"}],
    "type": "function"
}, {
    "constant": true,
    "inputs": [{"name": "yBit", "type": "uint8"}, {"name": "Px", "type": "uint256"}],
    "name": "decompress",
    "outputs": [{"name": "", "type": "uint256[2]"}],
    "type": "function"
}];

describe('Crypto', function () {

    describe('Secp256k1Curve', function () {

        before(function (done) {
            this.timeout(300000); // 5 minutes.
            console.log("\tInitializing web3 and deploying the Secp256k1 test contract.");
            util.initWeb3(function (err) {
                if (err)
                    return done(err);
                util.deploy(ABI, bytecode, function (err, contract) {
                    if (err)
                        return done(err);
                    secp256k1 = contract;
                    done();
                });
            });
        });

        describe('#onCurve()', function () {

            it('should detect that the given points are on the curve', function (done) {
                this.timeout(10000);
                async.forEachOfSeries(testdata.randomPoints, function (point, idx, cb) {
                        secp256k1.onCurve(point, function (err, result) {
                            assert.ifError(err);
                            assert(result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

            it('should detect that the given points are not on the curve', function (done) {
                this.timeout(10000);
                async.forEachOfSeries(testdata.randomPoints, function (point, idx, cb) {
                        secp256k1.onCurve([point[0], point[0]], function (err, result) {
                            assert.ifError(err);
                            assert(!result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });
        });

        describe('#isPubKey()', function () {

            it('should detect that the given points are valid public keys', function (done) {
                this.timeout(10000);
                async.forEachOfSeries(testdata.randomPoints, function (point, idx, cb) {
                        secp256k1.isPubKey(point, function (err, result) {
                            assert.ifError(err);
                            assert(result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

            it('should detect that the given points are not valid public keys', function (done) {
                this.timeout(10000);
                async.forEachOfSeries(testdata.randomPoints, function (point, idx, cb) {
                        secp256k1.isPubKey([point[0], point[0]], function (err, result) {
                            assert.ifError(err);
                            assert(!result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });
        });

        describe('#validateSignature()', function () {

            it('should detect that the given signatures are valid', function (done) {
                this.timeout(10000);
                var message = testdata.message;
                async.forEachOfSeries(testdata.keypairs, function (keypair, idx, cb) {
                        var signature = testdata.signatures[idx];
                        secp256k1.validateSignature(message, signature, keypair.pub, function (err, result) {
                            assert.ifError(err);
                            assert(result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

            it('should detect that the public key does not correspond to the given signature', function (done) {
                this.timeout(10000);
                var message = testdata.message;
                async.forEachOfSeries(testdata.keypairs, function (keypair, idx, cb) {
                        var signature = testdata.signatures[17 - idx];
                        secp256k1.validateSignature(message, signature, keypair.pub, function (err, result) {
                            assert.ifError(err);
                            assert(!result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

            it('should detect that the given signatures and pubkeys are wrong for the given message', function (done) {
                this.timeout(10000);
                var message = "0x1234123412341234123412341234123412341234123412341234123412341234";
                async.forEachOfSeries(testdata.keypairs, function (keypair, idx, cb) {
                        var signature = testdata.signatures[idx];
                        secp256k1.validateSignature(message, signature, keypair.pub, function (err, result) {
                            assert.ifError(err);
                            assert(!result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

            it('should compress a set of points successfully', function (done) {
                this.timeout(10000);
                async.forEachOfSeries(testdata.keypairs, function (keypair, idx, cb) {
                        secp256k1.compress(keypair.pub, function (err, result) {
                            assert.ifError(err);
                            var x = new BigNumber(keypair.pub[0]);
                            var yBit = new BigNumber(keypair.pub[1]).mod(2);
                            assert(yBit.eq(result[0]));
                            assert(x.eq(result[1]));
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

            it('should decompress a set of points successfully', function (done) {
                this.timeout(10000);
                async.forEachOfSeries(testdata.keypairs, function (keypair, idx, cb) {
                        var x = new BigNumber(keypair.pub[0]);
                        var yBit = new BigNumber(keypair.pub[1]).mod(2);
                        secp256k1.decompress(yBit, x, function (err, result) {
                            assert.ifError(err);
                            assert(new BigNumber(keypair.pub[0]).eq(result[0]));
                            assert(new BigNumber(keypair.pub[1]).eq(result[1]));
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

        });

    });

});